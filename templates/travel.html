<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flight Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:      #0d1117;
      --surface: #161b22;
      --border:  #30363d;
      --text:    #e6edf3;
      --muted:   #8b949e;
      --green:   #3fb950;
      --red:     #f85149;
      --accent:  #58a6ff;
      --gold:    #d2a734;
    }
    body       { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; }
    .nav-brand { font-size: 1.1rem; font-weight: 700; color: var(--accent); }
    .card      { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; }

    /* Stats bar */
    .stat-item { text-align: center; }
    .stat-val  { font-size: 1.6rem; font-weight: 700; }
    .stat-lbl  { font-size: .72rem; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }

    /* Trip card header */
    .trip-hd {
      background: #1c2128;
      border-bottom: 1px solid var(--border);
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .trip-title { font-size: 1rem; font-weight: 700; }
    .meta-pill {
      font-size: .72rem;
      padding: 2px 9px;
      border-radius: 20px;
      background: rgba(88,166,255,.12);
      color: var(--accent);
    }
    .alert-pill {
      font-size: .72rem;
      padding: 2px 9px;
      border-radius: 20px;
      background: rgba(248,81,73,.15);
      color: var(--red);
      border: 1px solid rgba(248,81,73,.35);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%,100% { opacity: 1; }
      50%      { opacity: .6; }
    }

    /* Best deal row */
    .best-deal {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
    }
    .price-big  { font-size: 1.5rem; font-weight: 700; color: var(--green); }
    .price-delta-down { font-size: .82rem; color: var(--green); }
    .price-delta-up   { font-size: .82rem; color: var(--red); }

    .preferred-badge {
      font-size: .68rem;
      padding: 2px 7px;
      border-radius: 20px;
      background: rgba(63,185,80,.15);
      color: var(--green);
      border: 1px solid rgba(63,185,80,.3);
    }

    /* Candidates table */
    .table      { --bs-table-bg: transparent; }
    .table th   { color: var(--muted); font-size: .75rem; text-transform: uppercase; letter-spacing: .05em; border-color: var(--border); }
    .table td   { border-color: var(--border); font-size: .85rem; vertical-align: middle; }

    /* Empty state */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
    .empty-state i { font-size: 3rem; margin-bottom: 16px; display: block; }

    /* Book button */
    .btn-book {
      font-size: .75rem;
      padding: 3px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      white-space: nowrap;
    }
    .btn-book:hover { border-color: var(--accent); color: var(--accent); }

    /* No data row in candidates */
    .no-data { color: var(--muted); font-size: .82rem; text-align: center; padding: 20px; }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar px-4 py-3" style="border-bottom:1px solid var(--border); background:var(--surface);">
  <div class="d-flex align-items-center gap-3">
    <a href="/" class="nav-brand text-decoration-none">
      <i class="bi bi-graph-up-arrow me-2"></i>Portfolio Dashboard
    </a>
    <a href="/jobs" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-briefcase me-1"></i>Jobs
    </a>
    <a href="/travel" class="btn btn-sm" style="background:rgba(88,166,255,.12);color:var(--accent);border-color:var(--accent);">
      <i class="bi bi-airplane me-1"></i>Flights
    </a>
  </div>
  <div class="d-flex align-items-center gap-2">
    <span style="font-size:.8rem;color:var(--muted);">
      {% if data %}
        Last scan: {{ data.last_scan }}
      {% else %}
        No scan results yet
      {% endif %}
    </span>
  </div>
</nav>

<div class="container-fluid px-4 py-4" style="max-width:1000px;">

{% if not data %}
<!-- Empty state -->
<div class="empty-state">
  <i class="bi bi-airplane"></i>
  <h5>No flight scan results yet</h5>
  <p class="mb-4">Run the scanner to populate this page.</p>
  <code style="background:var(--surface);padding:10px 16px;border-radius:8px;font-size:.85rem;border:1px solid var(--border);">
    python -m travel_agent.run --verbose
  </code>
</div>

{% else %}

<!-- Stats bar -->
<div class="card p-4 mb-4">
  <div class="row text-center g-0">
    <div class="col stat-item">
      <div class="stat-val" style="color:var(--accent);">{{ data.trip_count }}</div>
      <div class="stat-lbl">Trips Tracked</div>
    </div>
    <div class="col stat-item">
      <div class="stat-val" style="color:var(--red);">{{ data.alert_count }}</div>
      <div class="stat-lbl">Active Alerts</div>
    </div>
    <div class="col stat-item">
      {% set best_overall = namespace(price=None) %}
      {% for t in data.trips %}
        {% if t.best and (best_overall.price is none or t.best.price_per_person < best_overall.price) %}
          {% set best_overall.price = t.best.price_per_person %}
        {% endif %}
      {% endfor %}
      <div class="stat-val" style="color:var(--green);">
        {% if best_overall.price is not none %}${{ "{:,.0f}".format(best_overall.price) }}{% else %}—{% endif %}
      </div>
      <div class="stat-lbl">Best Deal Found</div>
    </div>
    <div class="col stat-item">
      {% set earliest = namespace(days=None, date=None) %}
      {% for t in data.trips %}
        {% if t.best and t.best.outbound_date %}
          {% set days_until = ((t.best.outbound_date | string)[:10]) %}
          {% if earliest.date is none or days_until < earliest.date %}
            {% set earliest.date = days_until %}
          {% endif %}
        {% endif %}
      {% endfor %}
      <div class="stat-val" style="color:var(--muted);">
        {{ earliest.date or "—" }}
      </div>
      <div class="stat-lbl">Earliest Departure</div>
    </div>
  </div>
</div>

<!-- Trip cards -->
{% for trip in data.trips %}
<div class="card mb-4">

  <!-- Trip header -->
  <div class="trip-hd">
    <i class="bi bi-airplane-fill" style="color:var(--accent);font-size:1.1rem;"></i>
    <span class="trip-title">{{ trip.name }}</span>
    <span class="meta-pill">{{ trip.travelers }} traveler{{ 's' if trip.travelers != 1 else '' }}</span>
    <span class="meta-pill">{{ trip.cabin | replace('_',' ') | title }}</span>
    {% if trip.preferred_airlines %}
      <span class="meta-pill">Preferred: {{ trip.preferred_airlines | join(', ') }}</span>
    {% endif %}
    {% if trip.alert_threshold %}
      <span class="meta-pill">Alert &lt; ${{ "{:,.0f}".format(trip.alert_threshold) }}</span>
    {% endif %}
    {% if trip.alert %}
      <span class="alert-pill"><i class="bi bi-bell-fill me-1"></i>PRICE ALERT</span>
    {% endif %}
  </div>

  <!-- Best deal row -->
  {% if trip.best %}
  {% set b = trip.best %}
  <div class="best-deal">
    <div>
      <div style="font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">Best Deal</div>
      <span class="price-big">${{ "{:,.0f}".format(b.price_per_person) }}<span style="font-size:.9rem;font-weight:400;color:var(--muted);"> /person</span></span>
      {% if trip.price_drop_pct is not none %}
        {% if trip.price_drop_pct > 0 %}
          <span class="price-delta-down ms-2">↓ {{ trip.price_drop_pct }}% vs last scan</span>
        {% elif trip.price_drop_pct < 0 %}
          <span class="price-delta-up ms-2">↑ {{ (trip.price_drop_pct * -1) | round(1) }}% vs last scan</span>
        {% endif %}
      {% endif %}
    </div>
    <div class="flex-grow-1">
      <div style="font-size:.88rem;font-weight:600;">
        {{ b.airline or b.airline_code }}
        {% if b.is_preferred %}<span class="preferred-badge ms-1">Preferred</span>{% endif %}
      </div>
      <div style="font-size:.8rem;color:var(--muted);margin-top:3px;">
        <i class="bi bi-calendar3 me-1"></i>{{ b.outbound_date }}
        {% if b.return_date %}&nbsp;→ return {{ b.return_date }}{% endif %}
        &nbsp;·&nbsp;
        <i class="bi bi-arrow-left-right me-1"></i>{{ b.stops }} stop{{ 's' if b.stops != 1 else '' }}
        {% if b.duration_minutes %}
          &nbsp;·&nbsp;
          <i class="bi bi-clock me-1"></i>{{ (b.duration_minutes // 60) }}h {{ (b.duration_minutes % 60) }}m
        {% endif %}
      </div>
    </div>
    {% if trip.prev_price %}
    <div style="font-size:.8rem;color:var(--muted);text-align:right;">
      <div>Prev: ${{ "{:,.0f}".format(trip.prev_price) }}</div>
    </div>
    {% endif %}
    <a href="{{ b.url }}" target="_blank" rel="noopener"
       class="btn btn-sm" style="background:rgba(88,166,255,.15);color:var(--accent);border-color:var(--accent);">
      <i class="bi bi-box-arrow-up-right me-1"></i>Book
    </a>
  </div>
  {% else %}
  <div class="p-4" style="color:var(--muted);font-size:.88rem;">
    <i class="bi bi-exclamation-circle me-2"></i>No flights found.
    {% if trip.errors %}
      {{ trip.errors | length }} error(s): {{ trip.errors[0] }}
    {% endif %}
  </div>
  {% endif %}

  <!-- Price history chart -->
  {% if trip.price_history and trip.price_history | length > 1 %}
  <div class="p-3" style="border-top:1px solid var(--border);">
    <div style="font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;">
      Price History (last 30 days)
    </div>
    <div style="height:140px;">
      <canvas id="chart_{{ trip.trip_id }}"></canvas>
    </div>
  </div>
  <script>
  (function() {
    const labels    = {{ trip.price_history | map(attribute='scanned_at') | map('truncate', 10, true, '') | list | tojson }};
    const prices    = {{ trip.price_history | map(attribute='best_price') | list | tojson }};
    const threshold = {{ trip.alert_threshold | default('null') }};
    const threshLine = threshold ? prices.map(() => threshold) : [];

    new Chart(document.getElementById('chart_{{ trip.trip_id }}'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Best Price',
            data: prices,
            borderColor: '#58a6ff',
            backgroundColor: 'rgba(88,166,255,.08)',
            borderWidth: 2,
            pointRadius: 3,
            fill: true,
            tension: 0.3,
          },
          ...(threshold ? [{
            label: 'Alert Threshold',
            data: threshLine,
            borderColor: 'rgba(248,81,73,.6)',
            borderWidth: 1,
            borderDash: [6, 4],
            pointRadius: 0,
            fill: false,
          }] : []),
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { labels: { color: '#8b949e', boxWidth: 10, font: { size: 10 } } },
          tooltip: {
            callbacks: {
              label: ctx => ' $' + ctx.parsed.y.toLocaleString()
            }
          }
        },
        scales: {
          x: { ticks: { color: '#8b949e', font: { size: 10 } }, grid: { color: '#21262d' } },
          y: {
            grid: { color: '#21262d' },
            ticks: { color: '#8b949e', font: { size: 10 },
                     callback: v => '$' + v.toLocaleString() }
          }
        }
      }
    });
  })();
  </script>
  {% endif %}

  <!-- Candidates table -->
  <div class="p-3" style="border-top:1px solid var(--border);">
    <div style="font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;">
      All Candidates (last scan)
    </div>
    {% if trip.candidates %}
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="candidates_{{ trip.trip_id }}">
        <thead>
          <tr>
            <th>Airline</th>
            <th>Date</th>
            <th class="text-end">Price/Person</th>
            <th class="text-end">Total</th>
            <th class="text-end">Stops</th>
            <th class="text-end">Duration</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for f in trip.candidates %}
          <tr>
            <td>
              {{ f.airline or f.airline_code }}
              {% if f.is_preferred %}<span class="preferred-badge ms-1">Pref</span>{% endif %}
              <div style="font-size:.72rem;color:var(--muted);">{{ f.flight_number }}</div>
            </td>
            <td>{{ f.outbound_date }}{% if f.return_date %}<div style="font-size:.72rem;color:var(--muted);">ret: {{ f.return_date }}</div>{% endif %}</td>
            <td class="text-end" style="font-weight:600;color:var(--green);">${{ "{:,.0f}".format(f.price_per_person) }}</td>
            <td class="text-end" style="color:var(--muted);">${{ "{:,.0f}".format(f.total_price) }}</td>
            <td class="text-end">{{ f.stops }}</td>
            <td class="text-end">
              {% if f.duration_minutes %}
                {{ (f.duration_minutes // 60) }}h {{ (f.duration_minutes % 60) }}m
              {% else %}—{% endif %}
            </td>
            <td>
              <a href="{{ f.url }}" target="_blank" rel="noopener" class="btn-book">Book →</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="no-data"><i class="bi bi-inbox me-2"></i>No candidate flights recorded.</div>
    {% endif %}
  </div>

</div>
{% endfor %}

{% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
